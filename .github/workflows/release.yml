name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: æ„å»ºå¹¶å‘ç‰ˆ
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç”Ÿæˆå‘å¸ƒæ—¥å¿— (changelog.md)
        id: generate_changelog
        shell: bash
        run: |
          set -e
          
          TAGS=$(git tag -l --sort=-committerdate | head -n 2)
          CURRENT_TAG=$(echo "$TAGS" | sed -n '1p')
          PREVIOUS_TAG=$(echo "$TAGS" | sed -n '2p')
          
          echo "Current: $CURRENT_TAG, Previous: $PREVIOUS_TAG"
          
          if [ -z "$PREVIOUS_TAG" ]; then
            RANGE="$CURRENT_TAG"
          else
            RANGE="$PREVIOUS_TAG..$CURRENT_TAG"
          fi

          RAW_LOGS=$(git log --pretty=format:"%s - by @%an (%h)" "$RANGE")

          get_commits() {
            local grep_pattern="$1"
            echo "$RAW_LOGS" | grep -E "$grep_pattern" || true
          }

          echo "# Release $CURRENT_TAG" > changelog.md
          echo "" >> changelog.md

          BREAKING=$(git log --pretty=format:"%s - by @%an (%h)" "$RANGE" --grep="BREAKING CHANGE" --grep="!:" || true)
          if [ -n "$BREAKING" ]; then
            echo "### ğŸš¨ BREAKING CHANGES ç ´åæ€§æ›´æ–°" >> changelog.md
            echo "$BREAKING" | sed 's/^/- /' >> changelog.md
            echo "" >> changelog.md
          fi

          # å¤„ç†å„ä¸ªåˆ†ç±»
          # å®šä¹‰åˆ†ç±»æ˜ å°„ï¼šæ˜¾ç¤ºæ ‡é¢˜|grepæ­£åˆ™
          categories=(
            "ğŸš€ Features æ–°åŠŸèƒ½|^feat"
            "ğŸ©¹ Fixes ç¼ºé™·ä¿®å¤|^fix"
            "ğŸ“– Documentation æ–‡æ¡£|^docs"
            "ğŸ”¥ Performance æ€§èƒ½ä¼˜åŒ–|^perf"
            "â™»ï¸ Refactors é‡æ„|^refactor"
          )

          for category in "${categories[@]}"; do
            TITLE="${category%%|*}"
            PATTERN="${category##*|}"
            
            MSGS=$(get_commits "$PATTERN")
            if [ -n "$MSGS" ]; then
              echo "### $TITLE" >> changelog.md
              # ç»™æ¯ä¸€è¡Œæ·»åŠ åˆ—è¡¨ç¬¦å·
              echo "$MSGS" | sed 's/^/- /' >> changelog.md
              echo "" >> changelog.md
            fi
          done

          echo "Changelog generated:"
          cat changelog.md

      - name: åˆ›å»º GitHub Release
        uses: ncipollo/release-action@v1.14.0
        with:
          bodyFile: changelog.md
          token: ${{ secrets.GITHUB_TOKEN }}

  publish:
    name: å‘å¸ƒåˆ° NPM
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read # å‘å¸ƒåªéœ€è¯»æƒé™
      id-token: write # ç”¨äº NPM Provenance
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… PNPM
        uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£…ä¾èµ–
        run: pnpm i --frozen-lockfile

      - name: æ‰“åŒ…
        run: pnpm build

      - name: æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [[ "v$PKG_VERSION" != "${{ github.ref_name }}" ]]; then
            echo "Error: Tag ${{ github.ref_name }} does not match package.json version v$PKG_VERSION"
            exit 1
          fi

      - name: å‘å¸ƒåˆ° NPM
        run: pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
          NPM_CONFIG_PROVENANCE: true